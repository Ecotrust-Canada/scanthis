<!DOCTYPE html>
<html data-ng-app="monospaced.qrcode">
<!-- License:  LGPL 2.1 or QZ INDUSTRIES SOURCE CODE LICENSE -->
<head><title>QZ Print Plugin</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script type="text/javascript" src="bower_components/angular/angular.js"></script>
<script type="text/javascript" src="bower_components/qrcode-generator/js/qrcode.js"></script>
<script type="text/javascript" src="bower_components/angular-qrcode/angular-qrcode.js"></script>
<script type="text/javascript" src="js/qzdeps/3rdparty/jquery-1.10.2.js"></script>
<script type="text/javascript" src="js/qzdeps/qz-websocket.js"></script>
<script type="text/javascript">

/**
 * Deploy tray version of QZ, or
 * Optionally used to deploy multiple versions of the applet for mixed
 * environments.  Oracle uses document.write(), which puts the applet at the
 * top of the page, bumping all HTML content down.
 */
deployQZ();

function getCertificate(callback) {
    callback();
}

function signRequest(toSign, callback) {
    callback();
}


/**
 * Automatically gets called when applet has loaded.
 */
function qzReady() {
    /* If the qz object hasn't been created, fallback on the <applet> tags */
    if (!qz) {
        window["qz"] = document.getElementById('qz');
    }
    if (qz) {
        try {
            qz.getVersion();
        } catch(err) {
        }
    }
}

function qzSocketError(event) {
    console.log('Error:');
    console.log(event);

}

function qzSocketClose(event) {
    console.log('Close:');
    console.log(event);

}

function qzNoConnection() {
    alert("Unable to connect to QZ, is it running?");

    var newElem = document.createElement('ins');
    newElem.innerHTML = content;

    document.write = oldWrite;
    document.body.appendChild(newElem);
}

/**
 * Returns whether or not the applet is not ready to print.
 * Displays an alert if not ready.
 */
function notReady() {
    /* If applet is not loaded, display an error */
    if (!isLoaded()) {
        return true;
    }
    /* If a printer hasn't been selected, display a message. */
    else if (!qz.getPrinter()) {
        alert('Please select a printer first by using the "Detect Printer" button.');
        return true;
    }
    return false;
}

/**
 * Returns is the applet is not loaded properly
 */
function isLoaded() {
    if (!qz) {
        alert('Error:\n\n\tPrint plugin is NOT loaded!');
        return false;
    } else {
        try {
            if (!qz.isActive()) {
                alert('Error:\n\n\tPrint plugin is loaded but NOT active!');
                return false;
            }
        } catch (err) {
            alert('Error:\n\n\tPrint plugin is NOT loaded properly!');
            return false;
        }
    }
    return true;
}

/**
 * Automatically gets called when "qz.print()" is finished.
 */
function qzDonePrinting() {
    /* Alert error, if any */
    if (qz.getException()) {
        alert('Error printing:\n\n\t' + qz.getException().getLocalizedMessage());
        qz.clearException();
        return;
    }

    /* Alert success message */
    alert('Successfully sent print data to "' + qz.getPrinter() + '" queue.');
}



/***************************************************************************
 * Prototype function for finding the closest match to a printer name.
 * Usage:
 *    qz.findPrinter('zebra');
 *    window['qzDoneFinding'] = function() { alert(qz.getPrinter()); };
 ***************************************************************************/
function findPrinter(name) {
    /* Get printer name from input box */
    if (isLoaded()) {
        /* Searches for locally installed printer with specified name */
        qz.findPrinter(name);

        /* Automatically gets called when "qz.findPrinter()" is finished. */
        window['qzDoneFinding'] = function() {
            var printer = qz.getPrinter();

            /* Alert the printer name to user */
            alert(printer !== null ? 'Printer found: "' + printer +
            '" after searching for "' + name + '"' : 'Printer "' +
            p.value + '" not found.');

            /* Remove reference to this function */
            window['qzDoneFinding'] = null;
        };
    }
}




/***************************************************************************
 * Prototype function for printing an HTML screenshot of the existing page
 * Usage: (identical to appendImage(), but uses html2canvas for png rendering)
 *    qz.setPaperSize("8.5in", "11.0in"); 
 *    qz.setAutoSize(true);
 *    qz.appendImage($("canvas")[0].toDataURL('image/png'));
 ***************************************************************************/
function printHTML5Page() {
    $("#qz-status").html2canvas({
        canvas: hidden_screenshot,
        onrendered: function() {
            if (notReady()) { return; }
            /* Optional, set up custom page size.  These only work for PostScript printing. */
            /* setPaperSize() must be called before setAutoSize(), setOrientation(), etc. */
            qz.setPaperSize("8.5in", "11.0in");  /* US Letter */
            qz.setAutoSize(true);
            qz.appendImage($("canvas")[0].toDataURL('image/png'));

            /* qz.setCopies(3); */
            qz.setCopies(1);

            /* Automatically gets called when "qz.appendFile()" is finished. */
            window['qzDoneAppending'] = function() {
                /* Tell the applet to print. */
                qz.printPS();

                /* Remove reference to this function */
                window['qzDoneAppending'] = null;
            };
        }
    });
}

setTimeout(function(){findPrinter('PDF');},3000);
setTimeout(function(){printHTML5Page();},4000);

</script>
<script type="text/javascript" src="js/qzdeps/3rdparty/html2canvas.js"></script>
<script type="text/javascript" src="js/qzdeps/3rdparty/jquery.plugin.html2canvas.js"></script>
</head>

<body id="qz-status">

<table>
<tr>
    <td>
        <input type="button" onClick="findPrinter('PDF')" value="Detect Printer">
    </td>
    <td>
        <input type="button" onClick="printHTML5Page()" value="Print Current Page" />
    </td>
</tr>
</table>


</body>
<canvas id="hidden_screenshot" style="display:none;"></canvas>

</html>
